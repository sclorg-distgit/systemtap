commit aadc1c78eea8969d453341b50baa958dfe18ffe8
Author: Frank Ch. Eigler <fche@redhat.com>
Date:   Fri Feb 13 14:39:03 2015 -0500

    BZ1128209: add a configure --{enable,disable}-virt option
    
    It was desirable that a systemtap rpm be buildable in a predictable
    manner (in this case, without virthost support), even if prerequisites
    (libvirt etc.) were accidentally installed.

diff --git a/Makefile.am b/Makefile.am
index 6699894..5adcca4 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -54,8 +54,7 @@ noinst_HEADERS = sdt_types.h
 stap_LDADD = @stap_LIBS@ @sqlite3_LIBS@ @LIBINTL@ -lpthread
 stap_DEPENDENCIES =
 
-if HAVE_LIBVIRT
-if HAVE_LIBXML2
+if BUILD_VIRT
 bin_PROGRAMS += stapvirt
 stapvirt_SOURCES = stapvirt.c
 stapvirt_CFLAGS = $(AM_CFLAGS)
@@ -63,7 +62,6 @@ stapvirt_CFLAGS += $(libvirt_CFLAGS) $(libxml2_CFLAGS)
 stapvirt_LDFLAGS = $(AM_LDFLAGS)
 stapvirt_LDADD = $(libvirt_LIBS) $(libxml2_LIBS)
 endif
-endif
 
 endif
 
diff --git a/Makefile.in b/Makefile.in
index f1fe6d6..c59a5ca 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -91,7 +91,7 @@ bin_PROGRAMS = $(am__EXEEXT_1) $(am__EXEEXT_2)
 @BUILD_SERVER_TRUE@@BUILD_TRANSLATOR_TRUE@@HAVE_NSS_TRUE@am__append_4 = stap-serverd stap-gen-cert
 @BUILD_SERVER_TRUE@@BUILD_TRANSLATOR_TRUE@@HAVE_NSS_TRUE@am__append_5 = stap-server
 @BUILD_SERVER_TRUE@@BUILD_TRANSLATOR_TRUE@@HAVE_NSS_TRUE@am__append_6 = stap-start-server stap-stop-server
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@am__append_7 = stapvirt
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@am__append_7 = stapvirt
 @BUILD_TRANSLATOR_TRUE@@HAVE_AVAHI_TRUE@am__append_8 = $(avahi_CFLAGS)
 @BUILD_TRANSLATOR_TRUE@@HAVE_AVAHI_TRUE@am__append_9 = $(avahi_CFLAGS)
 @BUILD_TRANSLATOR_TRUE@@HAVE_AVAHI_TRUE@am__append_10 = $(avahi_LIBS)
@@ -147,7 +147,8 @@ CONFIG_CLEAN_FILES = includes/sys/sdt-config.h \
 	staprun/guest/stapsh@.service
 CONFIG_CLEAN_VPATH_FILES =
 @BUILD_TRANSLATOR_TRUE@am__EXEEXT_1 = stap$(EXEEXT)
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@am__EXEEXT_2 = stapvirt$(EXEEXT)
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@am__EXEEXT_2 =  \
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@	stapvirt$(EXEEXT)
 am__installdirs = "$(DESTDIR)$(bindir)" "$(DESTDIR)$(pkglibexecdir)" \
 	"$(DESTDIR)$(bindir)" "$(DESTDIR)$(pkglibexecdir)" \
 	"$(DESTDIR)$(oldincludedir)"
@@ -250,10 +251,11 @@ stap_sign_module_OBJECTS = $(am_stap_sign_module_OBJECTS)
 @BUILD_TRANSLATOR_TRUE@@HAVE_NSS_TRUE@	$(am__DEPENDENCIES_1)
 stap_sign_module_LINK = $(CXXLD) $(stap_sign_module_CXXFLAGS) \
 	$(CXXFLAGS) $(stap_sign_module_LDFLAGS) $(LDFLAGS) -o $@
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@am_stapvirt_OBJECTS = stapvirt-stapvirt.$(OBJEXT)
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@am_stapvirt_OBJECTS = stapvirt-stapvirt.$(OBJEXT)
 stapvirt_OBJECTS = $(am_stapvirt_OBJECTS)
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@stapvirt_DEPENDENCIES = $(am__DEPENDENCIES_1) \
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@	$(am__DEPENDENCIES_1)
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@stapvirt_DEPENDENCIES =  \
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@	$(am__DEPENDENCIES_1) \
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@	$(am__DEPENDENCIES_1)
 stapvirt_LINK = $(CCLD) $(stapvirt_CFLAGS) $(CFLAGS) \
 	$(stapvirt_LDFLAGS) $(LDFLAGS) -o $@
 am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
@@ -447,8 +449,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
@@ -580,12 +580,13 @@ oldinclude_HEADERS = includes/sys/sdt.h includes/sys/sdt-config.h
 @BUILD_TRANSLATOR_TRUE@	@LIBINTL@ -lpthread $(am__append_10) \
 @BUILD_TRANSLATOR_TRUE@	$(am__append_15)
 @BUILD_TRANSLATOR_TRUE@stap_DEPENDENCIES = $(am__append_21)
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@stapvirt_SOURCES = stapvirt.c
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@stapvirt_CFLAGS = $(AM_CFLAGS) \
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@	$(libvirt_CFLAGS) \
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@	$(libxml2_CFLAGS)
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@stapvirt_LDFLAGS = $(AM_LDFLAGS)
-@BUILD_TRANSLATOR_TRUE@@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@stapvirt_LDADD = $(libvirt_LIBS) $(libxml2_LIBS)
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@stapvirt_SOURCES = stapvirt.c
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@stapvirt_CFLAGS =  \
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@	$(AM_CFLAGS) \
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@	$(libvirt_CFLAGS) \
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@	$(libxml2_CFLAGS)
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@stapvirt_LDFLAGS = $(AM_LDFLAGS)
+@BUILD_TRANSLATOR_TRUE@@BUILD_VIRT_TRUE@stapvirt_LDADD = $(libvirt_LIBS) $(libxml2_LIBS)
 
 # Arrange for git_version.h to be regenerated at every "make".
 # Code fragment is based upon RadeonHD.am.
diff --git a/aclocal.m4 b/aclocal.m4
index be5bd31..c261205 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -20,8 +20,8 @@ You have another version of autoconf.  It may work, but is not guaranteed to.
 If you have problems, you may need to regenerate the build system entirely.
 To do so, use the procedure documented by the package, typically 'autoreconf'.])])
 
-# intlmacosx.m4 serial 5 (gettext-0.18.2)
-dnl Copyright (C) 2004-2013 Free Software Foundation, Inc.
+# intlmacosx.m4 serial 1 (gettext-0.17)
+dnl Copyright (C) 2004-2007 Free Software Foundation, Inc.
 dnl This file is free software; the Free Software Foundation
 dnl gives unlimited permission to copy and/or distribute it,
 dnl with or without modifications, as long as this notice is preserved.
@@ -35,40 +35,35 @@ dnl by the GNU Library General Public License, and the rest of the GNU
 dnl gettext package package is covered by the GNU General Public License.
 dnl They are *not* in the public domain.
 
-dnl Checks for special options needed on Mac OS X.
+dnl Checks for special options needed on MacOS X.
 dnl Defines INTL_MACOSX_LIBS.
 AC_DEFUN([gt_INTL_MACOSX],
 [
-  dnl Check for API introduced in Mac OS X 10.2.
+  dnl Check for API introduced in MacOS X 10.2.
   AC_CACHE_CHECK([for CFPreferencesCopyAppValue],
-    [gt_cv_func_CFPreferencesCopyAppValue],
+    gt_cv_func_CFPreferencesCopyAppValue,
     [gt_save_LIBS="$LIBS"
      LIBS="$LIBS -Wl,-framework -Wl,CoreFoundation"
-     AC_LINK_IFELSE(
-       [AC_LANG_PROGRAM(
-          [[#include <CoreFoundation/CFPreferences.h>]],
-          [[CFPreferencesCopyAppValue(NULL, NULL)]])],
+     AC_TRY_LINK([#include <CoreFoundation/CFPreferences.h>],
+       [CFPreferencesCopyAppValue(NULL, NULL)],
        [gt_cv_func_CFPreferencesCopyAppValue=yes],
        [gt_cv_func_CFPreferencesCopyAppValue=no])
      LIBS="$gt_save_LIBS"])
   if test $gt_cv_func_CFPreferencesCopyAppValue = yes; then
-    AC_DEFINE([HAVE_CFPREFERENCESCOPYAPPVALUE], [1],
-      [Define to 1 if you have the Mac OS X function CFPreferencesCopyAppValue in the CoreFoundation framework.])
+    AC_DEFINE([HAVE_CFPREFERENCESCOPYAPPVALUE], 1,
+      [Define to 1 if you have the MacOS X function CFPreferencesCopyAppValue in the CoreFoundation framework.])
   fi
-  dnl Check for API introduced in Mac OS X 10.3.
-  AC_CACHE_CHECK([for CFLocaleCopyCurrent], [gt_cv_func_CFLocaleCopyCurrent],
+  dnl Check for API introduced in MacOS X 10.3.
+  AC_CACHE_CHECK([for CFLocaleCopyCurrent], gt_cv_func_CFLocaleCopyCurrent,
     [gt_save_LIBS="$LIBS"
      LIBS="$LIBS -Wl,-framework -Wl,CoreFoundation"
-     AC_LINK_IFELSE(
-       [AC_LANG_PROGRAM(
-          [[#include <CoreFoundation/CFLocale.h>]],
-          [[CFLocaleCopyCurrent();]])],
+     AC_TRY_LINK([#include <CoreFoundation/CFLocale.h>], [CFLocaleCopyCurrent();],
        [gt_cv_func_CFLocaleCopyCurrent=yes],
        [gt_cv_func_CFLocaleCopyCurrent=no])
      LIBS="$gt_save_LIBS"])
   if test $gt_cv_func_CFLocaleCopyCurrent = yes; then
-    AC_DEFINE([HAVE_CFLOCALECOPYCURRENT], [1],
-      [Define to 1 if you have the Mac OS X function CFLocaleCopyCurrent in the CoreFoundation framework.])
+    AC_DEFINE([HAVE_CFLOCALECOPYCURRENT], 1,
+      [Define to 1 if you have the MacOS X function CFLocaleCopyCurrent in the CoreFoundation framework.])
   fi
   INTL_MACOSX_LIBS=
   if test $gt_cv_func_CFPreferencesCopyAppValue = yes || test $gt_cv_func_CFLocaleCopyCurrent = yes; then
@@ -78,7 +73,6 @@ AC_DEFUN([gt_INTL_MACOSX],
 ])
 
 # pkg.m4 - Macros to locate and utilise pkg-config.            -*- Autoconf -*-
-# serial 1 (pkg-config-0.24)
 # 
 # Copyright Â© 2004 Scott James Remnant <scott@netsplit.com>.
 #
@@ -105,12 +99,8 @@ AC_DEFUN([gt_INTL_MACOSX],
 # ----------------------------------
 AC_DEFUN([PKG_PROG_PKG_CONFIG],
 [m4_pattern_forbid([^_?PKG_[A-Z_]+$])
-m4_pattern_allow([^PKG_CONFIG(_(PATH|LIBDIR|SYSROOT_DIR|ALLOW_SYSTEM_(CFLAGS|LIBS)))?$])
-m4_pattern_allow([^PKG_CONFIG_(DISABLE_UNINSTALLED|TOP_BUILD_DIR|DEBUG_SPEW)$])
-AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])
-AC_ARG_VAR([PKG_CONFIG_PATH], [directories to add to pkg-config's search path])
-AC_ARG_VAR([PKG_CONFIG_LIBDIR], [path overriding pkg-config's built-in search path])
-
+m4_pattern_allow([^PKG_CONFIG(_PATH)?$])
+AC_ARG_VAR([PKG_CONFIG], [path to pkg-config utility])dnl
 if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
 	AC_PATH_TOOL([PKG_CONFIG], [pkg-config])
 fi
@@ -123,6 +113,7 @@ if test -n "$PKG_CONFIG"; then
 		AC_MSG_RESULT([no])
 		PKG_CONFIG=""
 	fi
+		
 fi[]dnl
 ])# PKG_PROG_PKG_CONFIG
 
@@ -131,20 +122,21 @@ fi[]dnl
 # Check to see whether a particular set of modules exists.  Similar
 # to PKG_CHECK_MODULES(), but does not set variables or print errors.
 #
-# Please remember that m4 expands AC_REQUIRE([PKG_PROG_PKG_CONFIG])
-# only at the first occurence in configure.ac, so if the first place
-# it's called might be skipped (such as if it is within an "if", you
-# have to call PKG_CHECK_EXISTS manually
+#
+# Similar to PKG_CHECK_MODULES, make sure that the first instance of
+# this or PKG_CHECK_MODULES is called, or make sure to call
+# PKG_CHECK_EXISTS manually
 # --------------------------------------------------------------
 AC_DEFUN([PKG_CHECK_EXISTS],
 [AC_REQUIRE([PKG_PROG_PKG_CONFIG])dnl
 if test -n "$PKG_CONFIG" && \
     AC_RUN_LOG([$PKG_CONFIG --exists --print-errors "$1"]); then
-  m4_default([$2], [:])
+  m4_ifval([$2], [$2], [:])
 m4_ifvaln([$3], [else
   $3])dnl
 fi])
 
+
 # _PKG_CONFIG([VARIABLE], [COMMAND], [MODULES])
 # ---------------------------------------------
 m4_define([_PKG_CONFIG],
@@ -152,8 +144,7 @@ m4_define([_PKG_CONFIG],
     pkg_cv_[]$1="$$1"
  elif test -n "$PKG_CONFIG"; then
     PKG_CHECK_EXISTS([$3],
-                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes ],
+                     [pkg_cv_[]$1=`$PKG_CONFIG --[]$2 "$3" 2>/dev/null`],
 		     [pkg_failed=yes])
  else
     pkg_failed=untried
@@ -198,17 +189,16 @@ and $1[]_LIBS to avoid the need to call pkg-config.
 See the pkg-config man page for more details.])
 
 if test $pkg_failed = yes; then
-   	AC_MSG_RESULT([no])
         _PKG_SHORT_ERRORS_SUPPORTED
         if test $_pkg_short_errors_supported = yes; then
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "$2" 2>&1`
         else 
-	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "$2" 2>&1`
+	        $1[]_PKG_ERRORS=`$PKG_CONFIG --print-errors "$2" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$$1[]_PKG_ERRORS" >&AS_MESSAGE_LOG_FD
 
-	m4_default([$4], [AC_MSG_ERROR(
+	ifelse([$4], , [AC_MSG_ERROR(dnl
 [Package requirements ($2) were not met:
 
 $$1_PKG_ERRORS
@@ -216,67 +206,28 @@ $$1_PKG_ERRORS
 Consider adjusting the PKG_CONFIG_PATH environment variable if you
 installed software in a non-standard prefix.
 
-_PKG_TEXT])[]dnl
-        ])
+_PKG_TEXT
+])],
+		[AC_MSG_RESULT([no])
+                $4])
 elif test $pkg_failed = untried; then
-     	AC_MSG_RESULT([no])
-	m4_default([$4], [AC_MSG_FAILURE(
+	ifelse([$4], , [AC_MSG_FAILURE(dnl
 [The pkg-config script could not be found or is too old.  Make sure it
 is in your PATH or set the PKG_CONFIG environment variable to the full
 path to pkg-config.
 
 _PKG_TEXT
 
-To get pkg-config, see <http://pkg-config.freedesktop.org/>.])[]dnl
-        ])
+To get pkg-config, see <http://pkg-config.freedesktop.org/>.])],
+		[$4])
 else
 	$1[]_CFLAGS=$pkg_cv_[]$1[]_CFLAGS
 	$1[]_LIBS=$pkg_cv_[]$1[]_LIBS
         AC_MSG_RESULT([yes])
-	$3
+	ifelse([$3], , :, [$3])
 fi[]dnl
 ])# PKG_CHECK_MODULES
 
-
-# PKG_INSTALLDIR(DIRECTORY)
-# -------------------------
-# Substitutes the variable pkgconfigdir as the location where a module
-# should install pkg-config .pc files. By default the directory is
-# $libdir/pkgconfig, but the default can be changed by passing
-# DIRECTORY. The user can override through the --with-pkgconfigdir
-# parameter.
-AC_DEFUN([PKG_INSTALLDIR],
-[m4_pushdef([pkg_default], [m4_default([$1], ['${libdir}/pkgconfig'])])
-m4_pushdef([pkg_description],
-    [pkg-config installation directory @<:@]pkg_default[@:>@])
-AC_ARG_WITH([pkgconfigdir],
-    [AS_HELP_STRING([--with-pkgconfigdir], pkg_description)],,
-    [with_pkgconfigdir=]pkg_default)
-AC_SUBST([pkgconfigdir], [$with_pkgconfigdir])
-m4_popdef([pkg_default])
-m4_popdef([pkg_description])
-]) dnl PKG_INSTALLDIR
-
-
-# PKG_NOARCH_INSTALLDIR(DIRECTORY)
-# -------------------------
-# Substitutes the variable noarch_pkgconfigdir as the location where a
-# module should install arch-independent pkg-config .pc files. By
-# default the directory is $datadir/pkgconfig, but the default can be
-# changed by passing DIRECTORY. The user can override through the
-# --with-noarch-pkgconfigdir parameter.
-AC_DEFUN([PKG_NOARCH_INSTALLDIR],
-[m4_pushdef([pkg_default], [m4_default([$1], ['${datadir}/pkgconfig'])])
-m4_pushdef([pkg_description],
-    [pkg-config arch-independent installation directory @<:@]pkg_default[@:>@])
-AC_ARG_WITH([noarch-pkgconfigdir],
-    [AS_HELP_STRING([--with-noarch-pkgconfigdir], pkg_description)],,
-    [with_noarch_pkgconfigdir=]pkg_default)
-AC_SUBST([noarch_pkgconfigdir], [$with_noarch_pkgconfigdir])
-m4_popdef([pkg_default])
-m4_popdef([pkg_description])
-]) dnl PKG_NOARCH_INSTALLDIR
-
 # Copyright (C) 2002-2013 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
diff --git a/configure b/configure
index e6f0d2d..567a5d3 100755
--- a/configure
+++ b/configure
@@ -642,6 +642,8 @@ HAVE_SELINUX_TRUE
 selinux_LIBS
 selinux_CFLAGS
 support_section_question
+BUILD_VIRT_FALSE
+BUILD_VIRT_TRUE
 HAVE_LIBXML2_FALSE
 HAVE_LIBXML2_TRUE
 libxml2_LIBS
@@ -671,8 +673,6 @@ HAVE_NSS_FALSE
 HAVE_NSS_TRUE
 nss_LIBS
 nss_CFLAGS
-PKG_CONFIG_LIBDIR
-PKG_CONFIG_PATH
 PKG_CONFIG
 BUILD_PDFREFDOCS_FALSE
 BUILD_PDFREFDOCS_TRUE
@@ -860,6 +860,7 @@ with_avahi
 with_rpm
 with_elfutils
 with_dyninst
+enable_virt
 with_selinux
 with_java
 with_extra_version
@@ -877,8 +878,6 @@ CXX
 CXXFLAGS
 CCC
 PKG_CONFIG
-PKG_CONFIG_PATH
-PKG_CONFIG_LIBDIR
 nss_CFLAGS
 nss_LIBS
 avahi_CFLAGS
@@ -1541,6 +1540,8 @@ Optional Features:
                           if xmlto etc. found and other documentation built).
   --enable-server         enable building of stap-server (default on if nss
                           etc. found).
+  --enable-virt           enable building of stapvirt support (default on if
+                          libvirt etc. found).
 
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
@@ -1578,10 +1579,6 @@ Some influential environment variables:
   CXX         C++ compiler command
   CXXFLAGS    C++ compiler flags
   PKG_CONFIG  path to pkg-config utility
-  PKG_CONFIG_PATH
-              directories to add to pkg-config's search path
-  PKG_CONFIG_LIBDIR
-              path overriding pkg-config's built-in search path
   nss_CFLAGS  C compiler flags for nss, overriding pkg-config
   nss_LIBS    linker flags for nss, overriding pkg-config
   avahi_CFLAGS
@@ -9913,11 +9910,6 @@ fi
 
 
 
-
-
-
-
-
 if test "x$ac_cv_env_PKG_CONFIG_set" != "xset"; then
 	if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}pkg-config", so it can be a program name with args.
@@ -10030,6 +10022,7 @@ $as_echo "yes" >&6; }
 $as_echo "no" >&6; }
 		PKG_CONFIG=""
 	fi
+
 fi
 if test "x$with_nss" != "xno"; then :
 
@@ -10048,7 +10041,6 @@ if test -n "$nss_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_nss_CFLAGS=`$PKG_CONFIG --cflags "nss >= 3" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -10065,7 +10057,6 @@ if test -n "$nss_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_nss_LIBS=`$PKG_CONFIG --libs "nss >= 3" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -10076,8 +10067,6 @@ fi
 
 
 if test $pkg_failed = yes; then
-   	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
 
 if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
         _pkg_short_errors_supported=yes
@@ -10085,17 +10074,17 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        nss_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "nss >= 3" 2>&1`
+	        nss_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "nss >= 3" 2>&1`
         else
-	        nss_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "nss >= 3" 2>&1`
+	        nss_PKG_ERRORS=`$PKG_CONFIG --print-errors "nss >= 3" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$nss_PKG_ERRORS" >&5
 
-	have_nss=no
-elif test $pkg_failed = untried; then
-     	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
+                have_nss=no
+elif test $pkg_failed = untried; then
 	have_nss=no
 else
 	nss_CFLAGS=$pkg_cv_nss_CFLAGS
@@ -10174,7 +10163,6 @@ if test -n "$avahi_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_avahi_CFLAGS=`$PKG_CONFIG --cflags "avahi-client" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -10191,7 +10179,6 @@ if test -n "$avahi_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_avahi_LIBS=`$PKG_CONFIG --libs "avahi-client" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -10202,8 +10189,6 @@ fi
 
 
 if test $pkg_failed = yes; then
-   	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
 
 if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
         _pkg_short_errors_supported=yes
@@ -10211,17 +10196,17 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        avahi_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "avahi-client" 2>&1`
+	        avahi_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "avahi-client" 2>&1`
         else
-	        avahi_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "avahi-client" 2>&1`
+	        avahi_PKG_ERRORS=`$PKG_CONFIG --print-errors "avahi-client" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$avahi_PKG_ERRORS" >&5
 
-	have_avahi=no
-elif test $pkg_failed = untried; then
-     	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
+                have_avahi=no
+elif test $pkg_failed = untried; then
 	have_avahi=no
 else
 	avahi_CFLAGS=$pkg_cv_avahi_CFLAGS
@@ -10889,6 +10874,15 @@ fi
 
 
 
+# Check whether --enable-virt was given.
+if test "${enable_virt+set}" = set; then :
+  enableval=$enable_virt; enable_virt=$enableval
+else
+  enable_virt="check"
+fi
+
+
+
 pkg_failed=no
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libvirt" >&5
 $as_echo_n "checking for libvirt... " >&6; }
@@ -10903,7 +10897,6 @@ if test -n "$libvirt_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_libvirt_CFLAGS=`$PKG_CONFIG --cflags "libvirt >= 1.0.2" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -10920,7 +10913,6 @@ if test -n "$libvirt_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_libvirt_LIBS=`$PKG_CONFIG --libs "libvirt >= 1.0.2" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -10931,8 +10923,6 @@ fi
 
 
 if test $pkg_failed = yes; then
-   	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
 
 if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
         _pkg_short_errors_supported=yes
@@ -10940,17 +10930,17 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        libvirt_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libvirt >= 1.0.2" 2>&1`
+	        libvirt_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libvirt >= 1.0.2" 2>&1`
         else
-	        libvirt_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libvirt >= 1.0.2" 2>&1`
+	        libvirt_PKG_ERRORS=`$PKG_CONFIG --print-errors "libvirt >= 1.0.2" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$libvirt_PKG_ERRORS" >&5
 
-	have_libvirt=no
-elif test $pkg_failed = untried; then
-     	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
+                have_libvirt=no
+elif test $pkg_failed = untried; then
 	have_libvirt=no
 else
 	libvirt_CFLAGS=$pkg_cv_libvirt_CFLAGS
@@ -10987,7 +10977,6 @@ if test -n "$libxml2_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_libxml2_CFLAGS=`$PKG_CONFIG --cflags "libxml-2.0" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -11004,7 +10993,6 @@ if test -n "$libxml2_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_libxml2_LIBS=`$PKG_CONFIG --libs "libxml-2.0" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -11015,8 +11003,6 @@ fi
 
 
 if test $pkg_failed = yes; then
-   	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
 
 if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
         _pkg_short_errors_supported=yes
@@ -11024,17 +11010,17 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        libxml2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libxml-2.0" 2>&1`
+	        libxml2_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libxml-2.0" 2>&1`
         else
-	        libxml2_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libxml-2.0" 2>&1`
+	        libxml2_PKG_ERRORS=`$PKG_CONFIG --print-errors "libxml-2.0" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$libxml2_PKG_ERRORS" >&5
 
-	have_libxml2=no
-elif test $pkg_failed = untried; then
-     	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
+                have_libxml2=no
+elif test $pkg_failed = untried; then
 	have_libxml2=no
 else
 	libxml2_CFLAGS=$pkg_cv_libxml2_CFLAGS
@@ -11057,6 +11043,26 @@ else
 fi
 
 
+if test "$enable_virt" != "no"; then
+  if test "x${have_libvirt}" != "xyes"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: will not build systemtap virt support, cannot find libvirt headers" >&5
+$as_echo "$as_me: WARNING: will not build systemtap virt support, cannot find libvirt headers" >&2;}
+  fi
+  if test "x${have_libxml2}" != "xyes"; then
+    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: will not build systemtap virt support, cannot find xml2 headers" >&5
+$as_echo "$as_me: WARNING: will not build systemtap virt support, cannot find xml2 headers" >&2;}
+  fi
+fi
+ if test "${have_libvirt}" == "yes" -a "${have_libxml2}" == "yes" -a "$enable_virt" != "no"; then
+  BUILD_VIRT_TRUE=
+  BUILD_VIRT_FALSE='#'
+else
+  BUILD_VIRT_TRUE='#'
+  BUILD_VIRT_FALSE=
+fi
+
+
+
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for assembler .section \"?\" flags support" >&5
 $as_echo_n "checking for assembler .section \"?\" flags support... " >&6; }
 if ${stap_cv_sectionq+:} false; then :
@@ -11188,7 +11194,6 @@ if test -n "$selinux_CFLAGS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_selinux_CFLAGS=`$PKG_CONFIG --cflags "libselinux" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -11205,7 +11210,6 @@ if test -n "$selinux_LIBS"; then
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
   test $ac_status = 0; }; then
   pkg_cv_selinux_LIBS=`$PKG_CONFIG --libs "libselinux" 2>/dev/null`
-		      test "x$?" != "x0" && pkg_failed=yes
 else
   pkg_failed=yes
 fi
@@ -11216,8 +11220,6 @@ fi
 
 
 if test $pkg_failed = yes; then
-   	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
 
 if $PKG_CONFIG --atleast-pkgconfig-version 0.20; then
         _pkg_short_errors_supported=yes
@@ -11225,17 +11227,17 @@ else
         _pkg_short_errors_supported=no
 fi
         if test $_pkg_short_errors_supported = yes; then
-	        selinux_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors --cflags --libs "libselinux" 2>&1`
+	        selinux_PKG_ERRORS=`$PKG_CONFIG --short-errors --print-errors "libselinux" 2>&1`
         else
-	        selinux_PKG_ERRORS=`$PKG_CONFIG --print-errors --cflags --libs "libselinux" 2>&1`
+	        selinux_PKG_ERRORS=`$PKG_CONFIG --print-errors "libselinux" 2>&1`
         fi
 	# Put the nasty error message in config.log where it belongs
 	echo "$selinux_PKG_ERRORS" >&5
 
-	have_selinux=no
-elif test $pkg_failed = untried; then
-     	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
 $as_echo "no" >&6; }
+                have_selinux=no
+elif test $pkg_failed = untried; then
 	have_selinux=no
 else
 	selinux_CFLAGS=$pkg_cv_selinux_CFLAGS
@@ -11678,6 +11680,10 @@ if test -z "${HAVE_LIBXML2_TRUE}" && test -z "${HAVE_LIBXML2_FALSE}"; then
   as_fn_error $? "conditional \"HAVE_LIBXML2\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
+if test -z "${BUILD_VIRT_TRUE}" && test -z "${BUILD_VIRT_FALSE}"; then
+  as_fn_error $? "conditional \"BUILD_VIRT\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
 if test -z "${HAVE_SELINUX_TRUE}" && test -z "${HAVE_SELINUX_FALSE}"; then
   as_fn_error $? "conditional \"HAVE_SELINUX\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
diff --git a/configure.ac b/configure.ac
index b540354..1778eff 100644
--- a/configure.ac
+++ b/configure.ac
@@ -526,8 +526,15 @@ if test "$with_dyninst" != "no"; then
 fi
 AM_CONDITIONAL([HAVE_DYNINST], [test "${have_dyninst}" = "yes"])
 
+
 dnl Check for the libvirt and libxml2 devel packages
 
+AC_ARG_ENABLE([virt],
+  AS_HELP_STRING([--enable-virt],
+    [enable building of stapvirt support (default on if libvirt etc. found).]),
+  [enable_virt=$enableval],
+  [enable_virt="check"])
+
 dnl We require libvirt >= 1.0.2 because stapvirt relies on the
 dnl virDomainOpenChannel function, which was implemented in 1.0.2.
 PKG_CHECK_MODULES([libvirt], [libvirt >= 1.0.2], [
@@ -541,6 +548,18 @@ PKG_CHECK_MODULES([libxml2], [libxml-2.0], [
    ], [have_libxml2=no])
 AM_CONDITIONAL([HAVE_LIBXML2], [test "${have_libxml2}" = "yes"])
 
+if test "$enable_virt" != "no"; then
+dnl See if we have enough libraries and tools to build the virt server
+  if test "x${have_libvirt}" != "xyes"; then
+    AC_MSG_WARN([will not build systemtap virt support, cannot find libvirt headers])
+  fi		       
+  if test "x${have_libxml2}" != "xyes"; then
+    AC_MSG_WARN([will not build systemtap virt support, cannot find xml2 headers])
+  fi		       
+fi
+AM_CONDITIONAL([BUILD_VIRT], [test "${have_libvirt}" == "yes" -a "${have_libxml2}" == "yes" -a "$enable_virt" != "no"])
+
+
 AC_CACHE_CHECK([for assembler .section "?" flags support], stap_cv_sectionq, [
 old_CFLAGS="$CFLAGS"
 CFLAGS="$CFLAGS -Wa,--fatal-warnings"
diff --git a/doc/Makefile.in b/doc/Makefile.in
index 45521e6..7a070ef 100644
--- a/doc/Makefile.in
+++ b/doc/Makefile.in
@@ -216,8 +216,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/doc/SystemTap_Tapset_Reference/Makefile.in b/doc/SystemTap_Tapset_Reference/Makefile.in
index c2f515a..52b4978 100644
--- a/doc/SystemTap_Tapset_Reference/Makefile.in
+++ b/doc/SystemTap_Tapset_Reference/Makefile.in
@@ -225,8 +225,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/doc/beginners/Makefile.in b/doc/beginners/Makefile.in
index 4eba062..bafb973 100644
--- a/doc/beginners/Makefile.in
+++ b/doc/beginners/Makefile.in
@@ -188,8 +188,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/java/Makefile.in b/java/Makefile.in
index f5eec5a..a881a1e 100644
--- a/java/Makefile.in
+++ b/java/Makefile.in
@@ -271,8 +271,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/man/Makefile.am b/man/Makefile.am
index ef0892e..4116ff5 100644
--- a/man/Makefile.am
+++ b/man/Makefile.am
@@ -28,9 +28,7 @@ man_MANS += stap-server.8
 endif
 endif
 
-if HAVE_LIBVIRT
-if HAVE_LIBXML2
+if BUILD_VIRT
 man_MANS += stapvirt.1
 endif
-endif
 
diff --git a/man/Makefile.in b/man/Makefile.in
index ae68814..2c7493f 100644
--- a/man/Makefile.in
+++ b/man/Makefile.in
@@ -82,7 +82,7 @@ host_triplet = @host@
 target_triplet = @target@
 @BUILD_TRANSLATOR_TRUE@am__append_1 = stap.1 stap-prep.1 stap-report.1
 @BUILD_SERVER_TRUE@@HAVE_NSS_TRUE@am__append_2 = stap-server.8
-@HAVE_LIBVIRT_TRUE@@HAVE_LIBXML2_TRUE@am__append_3 = stapvirt.1
+@BUILD_VIRT_TRUE@am__append_3 = stapvirt.1
 subdir = man
 DIST_COMMON = $(srcdir)/Makefile.in $(srcdir)/Makefile.am \
 	$(srcdir)/stappaths.7.in $(srcdir)/systemtap.8.in
@@ -221,8 +221,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/stapdyn/Makefile.in b/stapdyn/Makefile.in
index f384d0f..fe85082 100644
--- a/stapdyn/Makefile.in
+++ b/stapdyn/Makefile.in
@@ -280,8 +280,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/staprun/Makefile.in b/staprun/Makefile.in
index 525b9e8..4596c96 100644
--- a/staprun/Makefile.in
+++ b/staprun/Makefile.in
@@ -319,8 +319,6 @@ PIECFLAGS = @PIECFLAGS@
 PIECXXFLAGS = @PIECXXFLAGS@
 PIELDFLAGS = @PIELDFLAGS@
 PKG_CONFIG = @PKG_CONFIG@
-PKG_CONFIG_LIBDIR = @PKG_CONFIG_LIBDIR@
-PKG_CONFIG_PATH = @PKG_CONFIG_PATH@
 POSUB = @POSUB@
 PUBLICAN_BRAND = @PUBLICAN_BRAND@
 RANLIB = @RANLIB@
diff --git a/systemtap.spec b/systemtap.spec
index f78783e..eded870 100644
--- a/systemtap.spec
+++ b/systemtap.spec
@@ -470,7 +470,13 @@ cd ..
 %global java_config --without-java
 %endif
 
-%configure %{?elfutils_config} %{dyninst_config} %{sqlite_config} %{crash_config} %{docs_config} %{pie_config} %{publican_config} %{rpm_config} %{java_config} --disable-silent-rules --with-extra-version="rpm %{version}-%{release}"
+%if %{with_virthost}
+%global virt_config --enable-virt
+%else
+%global virt_config --disable-virt
+%endif
+
+%configure %{?elfutils_config} %{dyninst_config} %{sqlite_config} %{crash_config} %{docs_config} %{pie_config} %{publican_config} %{rpm_config} %{java_config} %{virt_config} --disable-silent-rules --with-extra-version="rpm %{version}-%{release}"
 make %{?_smp_mflags}
 
 %if %{with_emacsvim}
